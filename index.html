<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GENZA Avatar Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#0f0f10;color:#eee;font-family:system-ui,Arial}
    #bar{position:fixed;inset:12px 12px auto 12px;display:flex;gap:8px;align-items:center;z-index:10;background:#171718;border:1px solid #2a2a2e;border-radius:10px;padding:8px 10px}
    select,button,input{background:#1f1f22;border:1px solid #333;color:#eee;padding:6px 8px;border-radius:8px}
    #app{position:fixed;inset:0}
  </style>
</head>
<body>
  <div id="bar">
    <label>Animation:</label>
    <select id="clips"><option>—</option></select>
    <button id="playPause">Pause</button>
    <button id="reload">Reload (cache-bust)</button>
    <input id="url" size="40" placeholder="?model=https://.../model.glb" />
    <button id="loadBtn">Load URL</button>
  </div>
  <canvas id="app"></canvas>

  <script type="module">
    // ===== Imports (ESM) =====
    import * as THREE from 'https://unpkg.com/three@0.165.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/DRACOLoader.js';
    import { RoomEnvironment } from 'https://unpkg.com/three@0.165.0/examples/jsm/environments/RoomEnvironment.js';

    // ===== DOM =====
    const canvas = document.getElementById('app');
    const clipsSel = document.getElementById('clips');
    const playPauseBtn = document.getElementById('playPause');
    const reloadBtn = document.getElementById('reload');
    const urlInput = document.getElementById('url');
    const loadBtn = document.getElementById('loadBtn');

    // ===== Renderer / Scene / Camera =====
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha:false });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f0f10);
    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(2.2, 1.6, 2.2);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 1.0, 0);
    controls.enableDamping = true;

    // IBL
    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;

    // Ground (мягкая тень-плоскость)
    const ground = new THREE.Mesh(
      new THREE.CircleGeometry(4, 64),
      new THREE.MeshStandardMaterial({ color: 0x111112, roughness: 0.9, metalness: 0.0 })
    );
    ground.rotation.x = -Math.PI/2;
    ground.position.y = 0;
    scene.add(ground);

    // ===== Loaders =====
    const loader = new GLTFLoader();
    const draco = new DRACOLoader();
    draco.setDecoderPath('https://unpkg.com/three@0.165.0/examples/jsm/libs/draco/'); // на случай .glb с Draco
    loader.setDRACOLoader(draco);

    let mixer = null;
    let modelRoot = null;
    let actions = [];
    let currentAction = null;

    // ===== Helpers =====
    function getModelUrl() {
      const q = new URLSearchParams(location.search);
      return q.get('model') || './avatar.glb';
    }

    async function loadModel(url) {
      // cache-bust для «Reload»
      if (url.includes('?')) url += '&v=' + Date.now(); else url += '?v=' + Date.now();

      // очистка прежней сцены/миксера
      if (mixer) { mixer.stopAllAction(); mixer.uncacheRoot(modelRoot); mixer = null; }
      if (modelRoot) { scene.remove(modelRoot); modelRoot.traverse(o=>{ if(o.isMesh){ o.geometry?.dispose?.(); o.material?.dispose?.(); }}); modelRoot = null; }
      actions = []; currentAction = null;

      const gltf = await loader.loadAsync(url);
      modelRoot = gltf.scene;
      scene.add(modelRoot);

      // нормализация масштаба/позы
      modelRoot.traverse(o => { if (o.isMesh) { o.castShadow = o.receiveShadow = true; o.frustumCulled = false; } });

      // автоцентрирование и авто-масштаб
      const box = new THREE.Box3().setFromObject(modelRoot);
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      modelRoot.position.sub(center); // в (0,0,0)
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const scale = 1.6 / maxDim;      // чтобы удобно в кадр
      modelRoot.scale.setScalar(scale);

      // Анимации
      clipsSel.innerHTML = '';
      if (gltf.animations && gltf.animations.length) {
        mixer = new THREE.AnimationMixer(modelRoot);
        actions = gltf.animations.map(clip => mixer.clipAction(clip));
        // заполнить селект
        gltf.animations.forEach((clip, i) => {
          const opt = document.createElement('option');
          opt.value = i; opt.textContent = clip.name || `Clip ${i+1}`;
          clipsSel.appendChild(opt);
        });
        // автостарт первой
        currentAction = actions[0];
        currentAction.reset().play();
        playPauseBtn.textContent = 'Pause';
      } else {
        const opt = document.createElement('option');
        opt.textContent = 'Нет анимаций в GLB';
        clipsSel.appendChild(opt);
      }

      // камера кадрирует модель
      const dist = 2.2;
      camera.position.set(dist, dist*0.8, dist);
      controls.target.set(0, size.y*0.3*scale, 0);
      controls.update();
    }

    // ===== UI events =====
    clipsSel.addEventListener('change', () => {
      if (!actions.length) return;
      const idx = parseInt(clipsSel.value, 10);
      if (Number.isNaN(idx)) return;
      if (currentAction) currentAction.stop();
      currentAction = actions[idx];
      currentAction.reset().play();
      playPauseBtn.textContent = 'Pause';
    });

    playPauseBtn.addEventListener('click', () => {
      if (!mixer || !currentAction) return;
      if (currentAction.paused) { currentAction.paused = false; playPauseBtn.textContent = 'Pause'; }
      else { currentAction.paused = true; playPauseBtn.textContent = 'Play'; }
    });

    reloadBtn.addEventListener('click', () => loadModel(getModelUrl()));

    loadBtn.addEventListener('click', () => {
      const u = urlInput.value.trim();
      if (u) {
        const next = new URL(location.href);
        next.searchParams.set('model', u);
        history.replaceState({}, '', next.toString());
        loadModel(u);
      }
    });

    // ===== Resize & Loop =====
    addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    const clock = new THREE.Clock();
    (function loop(){
      requestAnimationFrame(loop);
      const dt = clock.getDelta();
      mixer?.update(dt);
      controls.update();
      renderer.render(scene, camera);
    })();

    // ===== Start =====
    const initialUrl = getModelUrl();
    urlInput.value = initialUrl.startsWith('./') ? '' : initialUrl;
    loadModel(initialUrl);
  </script>
</body>
</html>
